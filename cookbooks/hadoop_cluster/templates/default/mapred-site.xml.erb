<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="configuration.xsl"?>

<!-- about these variables: http://archive.cloudera.com/cdh/3/hadoop/mapred-default.html -->
<!-- generated by chef, changes will be overwritten -->

<configuration>

<property> <name>mapred.job.tracker</name>                        <value><%= @hadoop[:jobtracker][:addr]  %>:<%= @hadoop[:jobtracker][:port] %></value></property>
<property> <name>mapred.job.tracker.http.address</name>           <value><%= @hadoop[:jobtracker][:addr]  %>:<%= @hadoop[:jobtracker][:dash_port] %></value></property>
<property> <name>mapred.task.tracker.http.address</name>          <value>0.0.0.0:<%= @hadoop[:tasktracker][:dash_port] %></value></property>

<property> <name>mapred.local.dir</name>                          <value><%= @hadoop[:tasktracker][:scratch_dirs].join(",") %></value><final>true</final></property>
<property> <name>mapred.system.dir</name>                         <value><%= @hadoop[:jobtracker ][:system_hdfsdir]    %></value><final>true</final></property>
<property> <name>mapreduce.jobtracker.staging.root.dir</name>     <value><%= @hadoop[:jobtracker ][:staging_hdfsdir]   %></value></property>
<property> <name>mapred.job.tracker.persist.jobstatus.dir</name>  <value><%= @hadoop[:jobtracker ][:jobstat_hdfsdir] %></value></property>


<!-- map tuning -->

<property> <name>io.sort.mb</name>                                <value><%= @hadoop[:io_sort_mb] %></value></property>
<property> <name>io.sort.record.percent</name>                    <value>0.15</value></property>
<property> <name>io.sort.spill.percent</name>                     <value>0.80</value></property>
<property> <name>mapred.min.split.size</name>                     <value><%= @hadoop[:min_split_size] %></value></property>

<!-- reduce tuning -->

<property> <name>io.sort.factor</name>                            <value><%= @hadoop[:io_sort_factor] %></value></property>
<property> <name>mapred.inmem.merge.threshold</name>              <value>0</value></property>
<property> <name>mapred.job.shuffle.input.buffer.percent</name>   <value><%= @hadoop[:shuffle_heap_frac]  %></value></property>
<property> <name>mapred.job.shuffle.merge.percent</name>          <value>0.66</value></property>
<property> <name>mapred.job.reduce.input.buffer.percent</name>    <value><%= @hadoop[:reduce_heap_frac]   %></value></property>

<property> <name>mapred.reduce.parallel.copies</name>             <value><%= @hadoop[:reducer_parallel_copies] %></value></property>

<!-- child jobs -->

<property> <name>mapred.child.java.opts</name>                    <value><%= @hadoop[:java_child_opts]   %></value></property>
<property> <name>mapred.map.child.java.opts</name>                <value><%= @hadoop[:java_map_opts]     %></value></property>
<property> <name>mapred.reduce.child.java.opts</name>             <value><%= @hadoop[:java_reduce_opts]  %></value></property>
<property> <name>mapred.child.ulimit</name>                       <value><%= @hadoop[:java_child_ulimit] %></value>        <final>true</final></property>
<property> <name>mapred.job.reuse.jvm.num.tasks</name>            <value>-1</value></property>

<!-- communication -->

<property> <name>mapred.tasktracker.map.tasks.maximum</name>      <value><%= @hadoop[:max_map_tasks] %></value>            <final>true</final></property>
<property> <name>mapred.tasktracker.reduce.tasks.maximum</name>   <value><%= @hadoop[:max_reduce_tasks] %></value>         <final>true</final></property>
<property> <name>tasktracker.http.threads</name>                  <value><%= @hadoop[:tasktracker][:http_threads] %></value> <final>true</final></property>
<property> <name>mapred.job.tracker.handler.count</name>          <value><%= @hadoop[:jobtracker ][:handler_count] %></value> <final>true</final></property>

<!-- compression -->

<property> <name>mapred.output.compress</name>                    <value><%= @hadoop[:compress_output]       %></value></property>
<property> <name>mapred.output.compression.type</name>            <value><%= @hadoop[:compress_output_type]  %></value></property>
<property> <name>mapred.output.compression.codec</name>           <value><%= @hadoop[:compress_output_codec] %></value></property>
<property> <name>mapred.compress.map.output</name>                <value><%= @hadoop[:compress_mapout]       %></value></property>
<property> <name>mapred.map.output.compression.codec</name>       <value><%= @hadoop[:compress_mapout_codec] %></value></property>

<!-- job scheduling -->

<property> <name>mapred.map.tasks.speculative.execution</name>    <value>true</value></property>
<property> <name>mapred.reduce.tasks.speculative.execution</name> <value>false</value></property>
<property> <name>mapred.reduce.slowstart.completed.maps</name>    <value>0.05</value></property>
<property> <name>mapred.submit.replication</name>                 <value>10</value></property>

<property> <name>mapred.jobtracker.taskScheduler</name>           <value>org.apache.hadoop.mapred.FairScheduler</value></property>
<property> <name>mapred.fairscheduler.allocation.file</name>      <value><%= @hadoop[:conf_dir] %>/fairscheduler.xml</value></property>

<!-- logging -->

<property> <name>mapred.userlog.retain.hours</name>               <value><%= @hadoop[:log_retention_hours] %></value></property>
<property> <name>mapred.jobtracker.retirejob.interval</name>      <value><%= (@hadoop[:log_retention_hours].to_f * 60 * 60 * 1000).to_i %></value></property>
<property> <name>mapred.jobtracker.retirejob.check</name>         <value>1200000</value></property>
<property> <name>mapred.jobtracker.completeuserjobs.maximum</name><value><%= @hadoop[:log_retention_count] %></value></property>
<!-- <property> <name>mapred.job.tracker.retiredjobs.cache.size</name> <value>1000</value></property> -->

<!-- Job Status Store (HADOOP-1876) - persistent job status storage in HDFS -->
<property> <name>mapred.job.tracker.persist.jobstatus.active</name><value>true</value></property>
<property> <name>mapred.job.tracker.persist.jobstatus.hours</name> <value><%= (@hadoop[:log_retention_hours].to_i * 10) %></value></property>

<%- if node[:hadoop][:jobtracker][:recover] %>
<property> <name>mapred.jobtracker.restart.recover</name>          <value>true</value></property>
<%- end %>

<property> <name>mapred.task.profile</name>                        <value><%= !! @hadoop[:task_profile] %></value></property>
<property> <name>mapred.task.profile.maps</name>                   <value>0-2</value></property>
<property> <name>mapred.task.profile.reduces</name>                <value>0-2</value></property>

<!-- Hue -->

<property> <name>jobtracker.thrift.address</name>                  <value>0.0.0.0:<%= @hadoop[:jobtracker][:thrift_port] %></value></property>
<property> <name>mapred.jobtracker.plugins</name>                  <value><%= @hadoop[:jobtracker][:plugins].join(",") %></value></property>

</configuration>
